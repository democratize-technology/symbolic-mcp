"""
SPDX-License-Identifier: MIT
Copyright (c) 2025 Symbolic MCP Contributors

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
"""

#!/usr/bin/env python3
"""
Minimal eval() security vulnerability test.

Tests the CRITICAL security issue in main.py line 1356.
"""

import ast
import sys

def test_eval_vulnerability():
    """Test if eval() vulnerability exists in the try_evaluate function"""

    # Simulate the vulnerable function from main.py lines 1344-1362
    def try_evaluate_vulnerable(condition, var_name, value):
        try:
            # This is the VULNERABLE version using eval() directly
            return eval(condition, {'__builtins__': {'min': min, 'max': max}}, {var_name: value})
        except:
            return None

    # Test legitimate cases
    legitimate_tests = [
        ("x > 0", "x", 5, True),
        ("x < 0", "x", -5, True),
        ("x == 5", "x", 5, True),
        ("x != 10", "x", 5, True),
    ]

    # Test malicious injection attempts
    malicious_tests = [
        ("__import__('os').system('echo PWNED')", "x", 1),
        ("(lambda: __import__('os').system('echo PWNED'))()", "x", 1),
        ("open('/etc/passwd', 'r').read() if True else 1", "x", 1),
        ("globals().__builtins__['__import__']('os').system('echo PWNED')", "x", 1),
        ("[__import__('os').system('echo PWNED')][0]", "x", 1),
    ]

    print("=== TESTING LEGITIMATE USE CASES ===")
    for condition, var, val, expected in legitimate_tests:
        result = try_evaluate_vulnerable(condition, var, val)
        status = "PASS" if result == expected else "FAIL"
        print(f"{status}: {condition} with {var}={val} -> {result}")

    print("\n=== TESTING MALICIOUS INJECTION ATTEMPTS ===")
    vulnerable_count = 0
    for condition, var, val in malicious_tests:
        result = try_evaluate_vulnerable(condition, var, val)
        if result is not None:
            vulnerable_count += 1
            print(f"VULNERABLE: {condition} -> EXECUTED (returned: {result})")
        else:
            print(f"BLOCKED: {condition} -> Blocked")

    return vulnerable_count

def test_restrictedpython_fix():
    """Test if RestrictedPython provides better security"""

    try:
        from RestrictedPython import compile_restricted
        from RestrictedPython.Guards import safe_builtins

        def try_evaluate_secure(condition, var_name, value):
            try:
                # This is the SECURE version using RestrictedPython
                code = compile_restricted(condition, '<string>', 'eval')
                if code is None:
                    return None  # Compilation failed due to security restrictions
                return eval(code, {'__builtins__': safe_builtins}, {var_name: value})
            except:
                return None

        print("\n=== TESTING RESTRICTEDPYTHON FIX ===")

        # Test legitimate cases still work
        legitimate_tests = [
            ("x > 0", "x", 5, True),
            ("x < 0", "x", -5, True),
            ("x == 5", "x", 5, True),
            ("x != 10", "x", 5, True),
        ]

        for condition, var, val, expected in legitimate_tests:
            result = try_evaluate_secure(condition, var, val)
            status = "PASS" if result == expected else "FAIL"
            print(f"{status}: {condition} with {var}={val} -> {result}")

        # Test malicious attempts are blocked
        malicious_tests = [
            ("__import__('os').system('echo PWNED')", "x", 1),
            ("(lambda: __import__('os').system('echo PWNED'))()", "x", 1),
            ("open('/etc/passwd', 'r').read() if True else 1", "x", 1),
            ("globals().__builtins__['__import__']('os').system('echo PWNED')", "x", 1),
        ]

        secure_count = 0
        for condition, var, val in malicious_tests:
            result = try_evaluate_secure(condition, var, val)
            if result is None:
                secure_count += 1
                print(f"BLOCKED: {condition} -> Securely blocked")
            else:
                print(f"VULNERABLE: {condition} -> EXECUTED (returned: {result})")

        return secure_count

    except ImportError:
        print("\n=== RESTRICTEDPYTHON NOT AVAILABLE ===")
        return -1

if __name__ == "__main__":
    print("CRITICAL SECURITY EVAL() VULNERABILITY TEST")
    print("=" * 50)

    vulnerable_count = test_eval_vulnerability()
    secure_count = test_restrictedpython_fix()

    print("\n" + "=" * 50)
    print("SECURITY ASSESSMENT:")

    if vulnerable_count > 0:
        print(f"❌ CRITICAL VULNERABILITY: {vulnerable_count} injection attempts executed")
        print("❌ The eval() in main.py:1356 is VULNERABLE to code injection")
        print("❌ CVSS 7.5+ - Remote Code Execution vulnerability")
        print("")
        print("REQUIRED FIX:")
        print("1. Line 1356 in main.py MUST use RestrictedPython.compile_restricted()")
        print("2. The current eval() call allows arbitrary code execution")
        print("3. This is a production-ready security vulnerability")
    else:
        print("✅ No immediate injection vulnerabilities detected")

    if secure_count >= 0:
        if secure_count == len(["__import__('os').system('echo PWNED')", "(lambda: __import__('os').system('echo PWNED'))()", "open('/etc/passwd', 'r').read() if True else 1", "globals().__builtins__['__import__']('os').system('echo PWNED')"]):
            print("✅ RestrictedPython provides effective protection")
        else:
            print(f"⚠️  RestrictedPython blocked {secure_count} attempts")

    print(f"\nFINAL VERDICT: {'VULNERABLE - DO NOT DEPLOY' if vulnerable_count > 0 else 'NEEDS FURTHER REVIEW'}")